<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediHub – Hospital Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/custom.css" rel="stylesheet">
</head>
<body>
    <div id="app">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary" v-if="currentUser">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-hospital"></i> MediHub
                </a>
                <div class="navbar-nav ms-auto">
                    <button v-if="currentUser && currentUser.role !== 'admin'" 
                            class="btn btn-outline-light btn-sm me-2" 
                            @click="openProfilePage()">
                        <i class="bi bi-person-gear"></i> Edit Profile
                    </button>
                    <button class="btn btn-outline-light btn-sm" @click="logout">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid">
            <!-- Messages -->
            <div v-if="error" class="alert alert-danger alert-dismissible fade show m-3">
                {{ error }}
                <button type="button" class="btn-close" @click="error = null"></button>
            </div>
            <div v-if="success" class="alert alert-success alert-dismissible fade show m-3">
                {{ success }}
                <button type="button" class="btn-close" @click="success = null"></button>
            </div>

            <!-- Homepage -->
            <div v-if="!currentUser && currentView === 'home'" class="homepage">
                <div class="hero-section d-flex align-items-center justify-content-center min-vh-100 bg-primary text-white">
                    <div class="container">
                        <div class="row justify-content-center">
                            <div class="col-lg-8 col-md-10 text-center">
                                <!-- Hospital Logo/Name -->
                                <div class="mb-4">
                                    <i class="bi bi-hospital icon-5x mb-3"></i>
                                    <h1 class="display-3 fw-bold mb-0">MediHub</h1>
                                </div>
                                
                                <!-- Tagline -->
                                <h2 class="h4 fw-light mb-4">
                                    "Seamless Hospital Management, Simplified"
                                </h2>
                                
                                <!-- Description -->
                                <p class="lead mb-5">
                                    Manage doctors, patients, appointments, and treatments<br>
                                    efficiently—all in one place.
                                </p>
                                
                                <!-- Action Buttons -->
                                <div class="d-flex gap-3 justify-content-center">
                                    <button class="btn btn-light btn-lg px-5 py-3" @click="currentView = 'login'">
                                        <i class="bi bi-box-arrow-in-right me-2"></i>Login
                                    </button>
                                    <button class="btn btn-outline-light btn-lg px-5 py-3" @click="currentView = 'register'">
                                        <i class="bi bi-person-plus me-2"></i>Register
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Page (Global) -->
            <div v-if="currentUser && appView === 'profile'" class="container my-4">
                <button class="btn btn-outline-secondary mb-3" @click="openDashboard()">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </button>
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <i class="bi bi-person-gear me-2"></i>
                        <h5 class="mb-0">Edit Profile</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info" v-if="currentUser.role === 'patient'">
                            <small><i class="bi bi-info-circle"></i> Complete your profile with additional information. All fields except name are optional.</small>
                        </div>
                        <form @submit.prevent="updateProfile">
                            <div class="row">
                                <div class="col-md-6" v-if="currentUser.role === 'doctor'">
                                    <div class="mb-3">
                                        <label for="profile_name" class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="profile_name" v-model="profileForm.name" required>
                                    </div>
                                </div>
                                <div class="col-md-6" v-if="currentUser.role === 'patient'">
                                    <div class="mb-3">
                                        <label for="patient_name" class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="patient_name" v-model="profileForm.name" required>
                                    </div>
                                </div>
                                <div class="col-md-6" v-if="currentUser.role === 'patient'">
                                    <div class="mb-3">
                                        <label for="patient_email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="patient_email" v-model="profileForm.email" required>
                                    </div>
                                </div>
                                <div class="col-md-6" v-if="currentUser.role === 'doctor'">
                                    <div class="mb-3">
                                        <label for="profile_specialization" class="form-label">Specialization</label>
                                        <input type="text" class="form-control" id="profile_specialization" v-model="profileForm.specialization" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="profile_phone" class="form-label">Phone</label>
                                        <input type="tel" class="form-control" id="profile_phone" v-model="profileForm.phone">
                                    </div>
                                </div>
                                <div class="col-md-6" v-if="currentUser.role === 'doctor'">
                                    <div class="mb-3">
                                        <label for="profile_experience" class="form-label">Experience (years)</label>
                                        <input type="number" class="form-control" id="profile_experience" v-model="profileForm.experience" min="0" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row" v-if="currentUser.role === 'doctor'">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="profile_qualification" class="form-label">Qualification</label>
                                        <input type="text" class="form-control" id="profile_qualification" v-model="profileForm.qualification" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="profile_consultation_fee" class="form-label">Consultation Fee</label>
                                        <input type="number" step="0.01" class="form-control" id="profile_consultation_fee" v-model="profileForm.consultation_fee" required>
                                    </div>
                                </div>
                            </div>

                            <div class="row" v-if="currentUser.role === 'patient'">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="patient_age" class="form-label">Age</label>
                                        <input type="number" class="form-control" id="patient_age" v-model="profileForm.age" min="0" max="120">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="patient_gender" class="form-label">Gender</label>
                                        <select class="form-control" id="patient_gender" v-model="profileForm.gender">
                                            <option value="">Select Gender</option>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row" v-if="currentUser.role === 'patient'">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label for="patient_address" class="form-label">Address</label>
                                        <textarea class="form-control" id="patient_address" v-model="profileForm.address" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                Save Changes
                            </button>
                        </form>
                    </div>
                </div>
            </div>
<style>
/* Custom styles for hero section */
.hero-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.hero-section .btn-light {
    font-weight: 600;
    transition: all 0.3s ease;
}

.hero-section .btn-light:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.hero-section .btn-outline-light {
    font-weight: 600;
    border-width: 2px;
    transition: all 0.3s ease;
}

.hero-section .btn-outline-light:hover {
    transform: translateY(-2px);
    background-color: rgba(255,255,255,0.1);
}
</style>

            <!-- Auth Forms -->
            <div v-if="!currentUser && (currentView === 'login' || currentView === 'register')" class="auth-container">
                <div class="container">
                    <div class="row justify-content-center align-items-center min-vh-100">
                        <div class="col-md-6 col-lg-5">
                            <div class="card shadow-lg">
                                <div class="card-body p-5">
                                    <!-- Login Form -->
                                    <div v-if="currentView === 'login'">
                                        <div class="text-center mb-4">
                                            <i class="bi bi-hospital icon-3x text-primary mb-3"></i>
                                            <h3 class="card-title">Sign In</h3>
                                            <p class="text-muted">Welcome to MediHub</p>
                                        </div>
                                        <form @submit.prevent="handleLogin">
                                            <div class="mb-3">
                                                <label for="username" class="form-label">Username</label>
                                                <input type="text" class="form-control" id="username" v-model="loginForm.username" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="password" class="form-label">Password</label>
                                                <input type="password" class="form-control" id="password" v-model="loginForm.password" required>
                                            </div>
                                            <button type="submit" class="btn btn-primary w-100 mb-3" :disabled="loading">
                                                <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                                Sign In
                                            </button>
                                        </form>
                                        <div class="text-center">
                                            <p class="mb-0">Don't have an account? 
                                                <a href="#" @click.prevent="currentView = 'register'" class="text-primary">Register as Patient</a>
                                            </p>
                                        </div>
                                        <div class="mt-4 p-3 bg-light rounded">
                                            <small class="text-muted">
                                                <strong>Demo Accounts:</strong><br>
                                                Admin: admin / admin123<br>
                                                Doctor: dr_smith / doctor123
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- Registration Form -->
                                    <div v-if="currentView === 'register'">
                                        <div class="text-center mb-4">
                                            <i class="bi bi-person-plus icon-3x text-primary mb-3"></i>
                                            <h3 class="card-title">Register as Patient</h3>
                                            <p class="text-muted">Create your patient account</p>
                                        </div>
                                        <form @submit.prevent="handleRegister">
                                            <div class="mb-3">
                                                <label for="reg_name" class="form-label">Name</label>
                                                <input type="text" class="form-control" id="reg_name" v-model="registerForm.name" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="reg_email" class="form-label">Email Id</label>
                                                <input type="email" class="form-control" id="reg_email" v-model="registerForm.email" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="reg_username" class="form-label">Username</label>
                                                <input type="text" class="form-control" id="reg_username" v-model="registerForm.username" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="reg_password" class="form-label">Password</label>
                                                <input type="password" class="form-control" id="reg_password" v-model="registerForm.password" required>
                                            </div>
                                            <button type="submit" class="btn btn-primary w-100 mb-3" :disabled="loading">
                                                <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                                Register
                                            </button>
                                        </form>
                                        <div class="text-center">
                                            <p class="mb-0">Already have an account? 
                                                <a href="#" @click.prevent="currentView = 'login'" class="text-primary">Sign In</a>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div v-if="currentUser && currentUser.role === 'admin' && appView === 'dashboard'" class="dashboard-container">
                <div class="container">
                    <!-- Welcome Message - Only show on main dashboard -->
                    <div v-if="adminView === 'dashboard'" class="mb-4">
                        <h3 class="text-primary mb-2">Welcome, {{ currentUser.name || currentUser.username }}!</h3>
                        <p class="text-muted fs-5">Manage doctors, patients, and appointments efficiently.</p>
                    </div>

                    <!-- Navigation -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <button v-if="adminView !== 'dashboard'" class="btn btn-outline-secondary mb-2" @click="adminView = 'dashboard'">
                                <i class="bi bi-arrow-left"></i> Back to Dashboard
                            </button>
                        </div>
                    </div>

                    <!-- Dashboard View -->
                    <div v-if="adminView === 'dashboard'">
                    
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.total_doctors || 0 }}</h4>
                                    <p class="mb-0">Total Doctors</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.total_patients || 0 }}</h4>
                                    <p class="mb-0">Total Patients</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.today_appointments || 0 }}</h4>
                                    <p class="mb-0">Today's Appointments</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.active_doctors || 0 }}</h4>
                                    <p class="mb-0">Active Doctors</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Section -->
<!--
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-search"></i> Search</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <input type="text" class="form-control" v-model="searchQuery" placeholder="Search doctors or patients...">
                                        <button class="btn btn-outline-primary" @click="searchDoctors">
                                            <i class="bi bi-search"></i> Search Doctors
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <input type="text" class="form-control" v-model="searchQuery" placeholder="Search patients...">
                                        <button class="btn btn-outline-success" @click="searchPatients">
                                            <i class="bi bi-search"></i> Search Patients
                                        </button>
                                    </div>
                                </div>
                            </div>
-->
                            
                            <!-- Search Results -->
<!--
                            <div v-if="searchResults.doctors.length > 0" class="mt-3">
                                <h6>Doctor Search Results:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Specialization</th>
                                                <th>Experience</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="doctor in searchResults.doctors" :key="doctor.id">
                                                <td>{{ doctor.name }}</td>
                                                <td>{{ doctor.specialization }}</td>
                                                <td>{{ doctor.experience }} years</td>
                                                <td>
                                                    <span class="badge" :class="doctor.is_active ? 'bg-success' : 'bg-danger'">
                                                        {{ doctor.is_active ? 'Active' : 'Inactive' }}
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div v-if="searchResults.patients.length > 0" class="mt-3">
                                <h6>Patient Search Results:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Phone</th>
                                                <th>Age</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="patient in searchResults.patients" :key="patient.id">
                                                <td>{{ patient.name }}</td>
                                                <td>{{ patient.user ? patient.user.email : 'N/A' }}</td>
                                                <td>{{ patient.phone }}</td>
                                                <td>{{ patient.age }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
-->

                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="doctors-tab" data-bs-toggle="tab" data-bs-target="#doctors" type="button" role="tab">
                                <i class="bi bi-person-badge"></i> Doctors
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="patients-tab" data-bs-toggle="tab" data-bs-target="#patients" type="button" role="tab">
                                <i class="bi bi-people"></i> Patients
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="departments-tab" data-bs-toggle="tab" data-bs-target="#admin-departments" type="button" role="tab">
                                <i class="bi bi-building"></i> Departments
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#appointments" type="button" role="tab">
                                <i class="bi bi-calendar"></i> Appointments
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="adminTabsContent">
                        <!-- Doctors Tab -->
                        <div class="tab-pane fade show active" id="doctors" role="tabpanel">
                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Manage Doctors</h5>
                                    <button class="btn btn-primary btn-sm" @click="showAddDoctorForm()">
                                        <i class="bi bi-plus"></i> Add Doctor
                                    </button>
                                </div>
                                <div class="card-body">
                                    <!-- Search Form -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <input type="text" class="form-control" placeholder="Search doctors by name or specialization..." v-model="doctorSearchQuery" @input="searchDoctors">
                                                <button class="btn btn-outline-secondary" type="button" @click="clearDoctorSearch">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <select class="form-control" v-model="doctorSpecializationFilter" @change="filterDoctorsBySpecialization">
                                                <option value="">All Specializations</option>
                                                <option v-for="spec in doctorSpecializations" :key="spec" :value="spec">{{ spec }}</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Specialization</th>
                                                    <th>Experience</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="doctor in filteredDoctors" :key="doctor.id">
                                                    <td>Dr. {{ doctor.name }}</td>
                                                    <td>{{ doctor.specialization }}</td>
                                                    <td>{{ doctor.experience }} years</td>
                                                    <td>
                                                        <span class="badge" :class="doctor.is_active ? 'bg-success' : 'bg-danger'">
                                                            {{ doctor.is_active ? 'Active' : 'Inactive' }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary me-1" @click="editDoctor(doctor)" title="Edit Doctor">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-warning" @click="toggleDoctorStatus(doctor)" :title="doctor.is_active ? 'Blacklist Doctor' : 'Activate Doctor'">
                                                            <i class="bi" :class="doctor.is_active ? 'bi-ban' : 'bi-check-circle'"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Patients Tab -->
                        <div class="tab-pane fade" id="patients" role="tabpanel">
                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Manage Patients</h5>
                                    <button class="btn btn-outline-primary" @click="showAddPatientForm">
                                        <i class="bi bi-plus"></i> Add Patient
                                    </button>
                                </div>
                                <div class="card-body">
                                    <!-- Search Form -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <input type="text" class="form-control" placeholder="Search patients by name..." v-model="patientSearchQuery" @input="searchPatients">
                                                <button class="btn btn-outline-secondary" type="button" @click="clearPatientSearch">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Sr. No</th>
                                                    <th>Name</th>
                                                    <th>Email</th>
                                                    <th>Phone</th>
                                                    <th>Age</th>
                                                    <th>Gender</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(patient, index) in filteredPatients" :key="patient.id" :class="{ 'table-danger': patient.is_blacklisted }">
                                                    <td>{{ index + 1 }}</td>
                                                    <td>
                                                        {{ getPatientPrefix() }}{{ patient.name }}
                                                        <span v-if="patient.is_blacklisted" class="badge bg-danger ms-2">Blacklisted</span>
                                                    </td>
                                                    <td>{{ patient.user ? patient.user.email : 'N/A' }}</td>
                                                    <td>{{ patient.phone }}</td>
                                                    <td>{{ patient.age }}</td>
                                                    <td>{{ patient.gender }}</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary me-1" @click="openAdminPatientEdit(patient)" title="Edit Patient Details">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-warning me-1" @click="togglePatientBlacklist(patient)" title="Blacklist/Unblacklist Patient">
                                                            <i class="bi bi-ban"></i> {{ patient.is_blacklisted ? 'Unblacklist' : 'Blacklist' }}
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-info" @click="openAdminPatientHistory(patient)" title="View Patient History">
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Admin Departments Tab -->
                        <div class="tab-pane fade" id="admin-departments" role="tabpanel">
                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Manage Departments</h5>
                                    <button class="btn btn-primary" @click="showAddDepartmentModal()">
                                        <i class="bi bi-plus"></i> Add Department
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Sr. No.</th>
                                                    <th>Department Name</th>
                                                    <th>Description</th>
                                                    <th>No. of Doctors</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(dept, index) in adminDepartments" :key="dept.id" :class="{ 'table-secondary': !dept.is_active }">
                                                    <td>{{ index + 1 }}</td>
                                                    <td>
                                                        {{ dept.name }}
                                                        <span v-if="!dept.is_active" class="badge bg-secondary ms-2">Inactive</span>
                                                    </td>
                                                    <td>{{ dept.description || '—' }}</td>
                                                    <td>{{ dept.doctor_count || 0 }}</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary me-1" @click="editDepartment(dept)" title="Edit Department">
                                                            <i class="bi bi-pencil"></i> Edit
                                                        </button>
                                                        <button v-if="dept.is_active" class="btn btn-sm btn-outline-warning" @click="deactivateDepartment(dept)" title="Deactivate Department" :disabled="dept.doctor_count > 0">
                                                            <i class="bi bi-x-circle"></i> Deactivate
                                                        </button>
                                                        <button v-else class="btn btn-sm btn-outline-success" @click="activateDepartment(dept)" title="Activate Department">
                                                            <i class="bi bi-check-circle"></i> Activate
                                                        </button>
                                                    </td>
                                                </tr>
                                                <tr v-if="adminDepartments.length === 0">
                                                    <td colspan="5" class="text-center text-muted">No departments found</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Add/Edit Department Modal -->
                            <div class="modal fade" id="departmentModal" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">{{ departmentFormMode === 'add' ? 'Add New Department' : 'Edit Department' }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <form @submit.prevent="saveDepartment">
                                            <div class="modal-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Department Name <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" v-model="departmentForm.name" required maxlength="100" placeholder="Enter department name">
                                                    <div class="form-text">Maximum 100 characters</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Description</label>
                                                    <textarea class="form-control" v-model="departmentForm.description" rows="4" placeholder="Enter department description (optional)"></textarea>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-primary" :disabled="loading">
                                                    <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                                    {{ departmentFormMode === 'add' ? 'Add Department' : 'Update Department' }}
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Appointments Tab -->
                        <div class="tab-pane fade" id="appointments" role="tabpanel">
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0">All Appointments</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Sr. No</th>
                                                    <th>Patient</th>
                                                    <th>Doctor</th>
                                                    <th>Department</th>
                                                    <th>Date & Time</th>
                                                    <th>Status</th>
                                                    <th>Patient History</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(appointment, index) in appointments" :key="appointment.id">
                                                    <td>{{ index + 1 }}</td>
                                                    <td>{{ getPatientPrefix() }}{{ appointment.patient ? appointment.patient.name : 'N/A' }}</td>
                                                    <td>Dr. {{ appointment.doctor ? appointment.doctor.name : 'N/A' }}</td>
                                                    <td>{{ appointment.doctor ? appointment.doctor.specialization : 'N/A' }}</td>
                                                    <td>{{ appointment.appointment_date }} {{ appointment.appointment_time }}</td>
                                                    <td>
                                                        <span class="badge" :class="getStatusClass(appointment.status)">
                                                            {{ appointment.status }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-info" @click="viewAppointmentPatientHistory(appointment)" title="View Patient History">
                                                            <i class="bi bi-clock-history"></i> View
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>

                    <!-- Add Doctor Page -->
                    <div v-if="adminView === 'add-doctor'" class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Add New Doctor</h5>
                        </div>
                        <div class="card-body">
                            <form @submit.prevent="addDoctor">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_name" class="form-label">Full Name</label>
                                            <input type="text" class="form-control" id="new_name" v-model="newDoctor.name" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_email" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="new_email" v-model="newDoctor.email" required>
                                            <small class="text-muted">Login credentials will be auto-generated</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_specialization" class="form-label">Specialization</label>
                                            <input type="text" class="form-control" id="new_specialization" v-model="newDoctor.specialization" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_experience" class="form-label">Experience (years)</label>
                                            <input type="number" class="form-control" id="new_experience" v-model="newDoctor.experience" min="0" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_phone" class="form-label">Phone</label>
                                            <input type="tel" class="form-control" id="new_phone" v-model="newDoctor.phone" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_qualification" class="form-label">Qualification</label>
                                            <input type="text" class="form-control" id="new_qualification" v-model="newDoctor.qualification" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="new_consultation_fee" class="form-label">Consultation Fee</label>
                                    <input type="number" step="0.01" class="form-control" id="new_consultation_fee" v-model="newDoctor.consultation_fee" required>
                                </div>
                                <button type="submit" class="btn btn-primary" :disabled="loading">
                                    <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                    Add Doctor
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Edit Doctor Page -->
                    <div v-if="adminView === 'edit-doctor'" class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Edit Doctor: {{ editingDoctor.name }}</h5>
                        </div>
                        <div class="card-body">
                            <form @submit.prevent="updateDoctor">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_name" class="form-label">Full Name</label>
                                            <input type="text" class="form-control" id="edit_name" v-model="editingDoctor.name" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_specialization" class="form-label">Specialization</label>
                                            <input type="text" class="form-control" id="edit_specialization" v-model="editingDoctor.specialization" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_experience" class="form-label">Experience (years)</label>
                                            <input type="number" class="form-control" id="edit_experience" v-model="editingDoctor.experience" min="0" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_phone" class="form-label">Phone</label>
                                            <input type="tel" class="form-control" id="edit_phone" v-model="editingDoctor.phone" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_qualification" class="form-label">Qualification</label>
                                            <input type="text" class="form-control" id="edit_qualification" v-model="editingDoctor.qualification" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_consultation_fee" class="form-label">Consultation Fee</label>
                                            <input type="number" step="0.01" class="form-control" id="edit_consultation_fee" v-model="editingDoctor.consultation_fee" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_is_active" v-model="editingDoctor.is_active">
                                        <label class="form-check-label" for="edit_is_active">
                                            Active Doctor
                                        </label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary" :disabled="loading">
                                    <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                    Update Doctor
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Edit Patient View -->
                    <div v-if="adminView === 'edit-patient'" class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Edit Patient Details</h5>
                        </div>
                        <div class="card-body">
                            <form @submit.prevent="updatePatient">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_patient_name" class="form-label">Full Name</label>
                                            <input type="text" class="form-control" id="edit_patient_name" v-model="editingPatient.name" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_patient_phone" class="form-label">Phone</label>
                                            <input type="text" class="form-control" id="edit_patient_phone" v-model="editingPatient.phone">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_patient_age" class="form-label">Age</label>
                                            <input type="number" class="form-control" id="edit_patient_age" v-model="editingPatient.age" min="1" max="120">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_patient_gender" class="form-label">Gender</label>
                                            <select class="form-control" id="edit_patient_gender" v-model="editingPatient.gender">
                                                <option value="">Select Gender</option>
                                                <option value="Male">Male</option>
                                                <option value="Female">Female</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_patient_address" class="form-label">Address</label>
                                    <textarea class="form-control" id="edit_patient_address" v-model="editingPatient.address" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_patient_medical_history" class="form-label">Medical History</label>
                                    <textarea class="form-control" id="edit_patient_medical_history" v-model="editingPatient.medical_history" rows="4"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary" :disabled="loading">
                                    <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                    Update Patient
                                </button>
                                <button type="button" class="btn btn-secondary ms-2" @click="adminView = 'dashboard'">
                                    Cancel
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Patient History View -->
                    <div v-if="adminView === 'patient-history'" class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Patient History - {{ selectedPatient?.name }}</h5>
                        </div>
                        <div class="card-body">
                            <div v-if="patientHistory.length === 0" class="text-center text-muted py-4">
                                <i class="bi bi-clock-history icon-3x mb-3"></i>
                                <p>No appointment history found for this patient.</p>
                            </div>
                            <div v-else class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Doctor</th>
                                            <th>Status</th>
                                            <th>Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="appointment in patientHistory" :key="appointment.id">
                                            <td>{{ new Date(appointment.appointment_date).toLocaleDateString() }}</td>
                                            <td>{{ appointment.appointment_time }}</td>
                                            <td>{{ appointment.doctor?.name || 'N/A' }}</td>
                                            <td>
                                                <span class="badge" :class="{
                                                    'bg-success': appointment.status === 'completed',
                                                    'bg-primary': appointment.status === 'booked',
                                                    'bg-warning': appointment.status === 'available',
                                                    'bg-danger': appointment.status === 'cancelled'
                                                }">
                                                    {{ appointment.status }}
                                                </span>
                                            </td>
                                            <td>{{ appointment.notes || 'N/A' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <button type="button" class="btn btn-secondary" @click="adminView = 'dashboard'">
                                Back to Dashboard
                            </button>
                        </div>
                    </div>

                    <!-- Add Patient View -->
                    <div v-if="adminView === 'add-patient'" class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Add New Patient</h5>
                        </div>
                        <div class="card-body">
                            <form @submit.prevent="addPatient">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_patient_name" class="form-label">Full Name *</label>
                                            <input type="text" class="form-control" id="new_patient_name" v-model="newPatient.name" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_patient_email" class="form-label">Email *</label>
                                            <input type="email" class="form-control" id="new_patient_email" v-model="newPatient.email" required>
                                            <small class="text-muted">Login credentials will be auto-generated</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_patient_phone" class="form-label">Phone *</label>
                                            <input type="text" class="form-control" id="new_patient_phone" v-model="newPatient.phone" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_patient_age" class="form-label">Age *</label>
                                            <input type="number" class="form-control" id="new_patient_age" v-model="newPatient.age" min="1" max="120" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_patient_gender" class="form-label">Gender</label>
                                            <select class="form-control" id="new_patient_gender" v-model="newPatient.gender">
                                                <option value="">Select Gender</option>
                                                <option value="Male">Male</option>
                                                <option value="Female">Female</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_patient_emergency_contact" class="form-label">Emergency Contact</label>
                                            <input type="text" class="form-control" id="new_patient_emergency_contact" v-model="newPatient.emergency_contact">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="new_patient_address" class="form-label">Address</label>
                                    <textarea class="form-control" id="new_patient_address" v-model="newPatient.address" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="new_patient_medical_history" class="form-label">Medical History</label>
                                    <textarea class="form-control" id="new_patient_medical_history" v-model="newPatient.medical_history" rows="4" placeholder="Any pre-existing conditions, allergies, or medical notes"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary" :disabled="loading">
                                    <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                    Add Patient
                                </button>
                                <button type="button" class="btn btn-secondary ms-2" @click="adminView = 'dashboard'">
                                    Cancel
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Credentials Display Modal -->
                    <div v-if="showCredentials" class="modal d-block" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Account Created Successfully</h5>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-success">
                                        <h6>Auto-Generated Login Credentials:</h6>
                                        <p><strong>Username:</strong> <code>{{ generatedCredentials.username }}</code></p>
                                        <p><strong>Password:</strong> <code>{{ generatedCredentials.password }}</code></p>
                                        <small class="text-muted">Please save these credentials and share them with the {{ credentialsType }}.</small>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" @click="closeCredentialsModal">
                                        Got it!
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Doctor Dashboard -->
            <div v-if="currentUser && currentUser.role === 'doctor' && appView === 'dashboard'" class="dashboard-container">
                <div class="container">
                    <!-- Welcome Message -->
                    <div class="mb-4">
                        <h3 class="text-primary mb-2">Welcome, Dr. {{ currentUser.name || currentUser.username }}!</h3>
                        <p class="text-muted fs-5">Here are your appointments for today.</p>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.today_appointments || 0 }}</h4>
                                    <p class="mb-0">Today's Appointments</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.upcoming_appointments || 0 }}</h4>
                                    <p class="mb-0">Upcoming Appointments</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.total_patients || 0 }}</h4>
                                    <p class="mb-0">Total Patients</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="doctorTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#doctor-appointments" type="button" role="tab">
                                <i class="bi bi-calendar"></i> Upcoming Appointments
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="patients-tab" data-bs-toggle="tab" data-bs-target="#doctor-patients" type="button" role="tab">
                                <i class="bi bi-people"></i> Assigned Patients
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="availability-tab" data-bs-toggle="tab" data-bs-target="#availability" type="button" role="tab">
                                <i class="bi bi-calendar-alt"></i> Set Availability
                            </button>
                        </li>
                        
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="treatment-tab" data-bs-toggle="tab" data-bs-target="#treatment" type="button" role="tab">
                                <i class="bi bi-file-medical"></i> Add Treatment
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="doctorTabsContent">
                        <!-- Appointments Tab -->
                        <div class="tab-pane fade show active" id="doctor-appointments" role="tabpanel">
                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Upcoming Appointments</h5>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                :class="{ active: appointmentFilter === 'upcoming' || !appointmentFilter }" 
                                                @click="DoctorModule.filterAppointments(this, 'upcoming')">
                                            Upcoming
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                :class="{ active: appointmentFilter === 'today' }" 
                                                @click="DoctorModule.filterAppointments(this, 'today')">
                                            Today's
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                :class="{ active: appointmentFilter === 'completed' }" 
                                                @click="DoctorModule.filterAppointments(this, 'completed')">
                                            Completed
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Sr. No</th>
                                                    <th>Patient</th>
                                                    <th>Date & Time</th>
                                                    <th>Age & Gender</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="appointment in doctorAppointments" :key="appointment.id">
                                                    <td>{{ appointment.sr_no }}</td>
                                                    <td>{{ getPatientPrefix() }}{{ appointment.patient ? appointment.patient.name : 'N/A' }}</td>
                                                    <td>{{ appointment.appointment_date }} {{ appointment.appointment_time }}</td>
                                                    <td>{{ appointment.patient ? appointment.patient.age : 'N/A' }} / {{ appointment.patient ? appointment.patient.gender : 'N/A' }}</td>
                                                    <td>
                                                        <span class="badge" :class="getStatusClass(appointment.status)">
                                                            {{ appointment.status }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <button v-if="appointment.status === 'booked'" 
                                                                class="btn btn-sm btn-success me-1" 
                                                                @click="DoctorModule.updateAppointmentStatus(this, appointment.id, 'completed')" 
                                                                title="Mark as Completed">
                                                            <i class="bi bi-check"></i> Complete
                                                        </button>
                                                        <button v-if="appointment.status === 'booked'" 
                                                                class="btn btn-sm btn-warning me-1" 
                                                                @click="DoctorModule.updateAppointmentStatus(this, appointment.id, 'cancelled')" 
                                                                title="Cancel Appointment">
                                                            <i class="bi bi-x"></i> Cancel
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-info me-1" 
                                                                @click="DoctorModule.viewPatientHistory(this, appointment.patient.id)" 
                                                                title="View Patient History">
                                                            <i class="bi bi-clock-history"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-primary" 
                                                                @click="addTreatment(appointment)" 
                                                                title="Add Treatment">
                                                            <i class="bi bi-journal-medical"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Assigned Patients Tab -->
                        <div class="tab-pane fade" id="doctor-patients" role="tabpanel">
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0">Assigned Patients</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Sr. No</th>
                                                    <th>Name</th>
                                                    <th>Phone</th>
                                                    <th>Age</th>
                                                    <th>Gender</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="patient in doctorPatients" :key="patient.id">
                                                    <td>{{ patient.sr_no }}</td>
                                                    <td>{{ patient.name }}</td>
                                                    <td>{{ patient.phone }}</td>
                                                    <td>{{ patient.age }}</td>
                                                    <td>{{ patient.gender }}</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-info" 
                                                                @click="DoctorModule.viewPatientHistory(this, patient.id)" 
                                                                title="View Patient History">
                                                            <i class="bi bi-eye"></i> View
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Availability Tab -->
                        <div class="tab-pane fade" id="availability" role="tabpanel">
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0">Set Availability & Create Slots</h5>
                                </div>
                                <div class="card-body">
                                    <form @submit.prevent="setAvailabilitySlots">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="start_date" class="form-label">Start Date</label>
                                                    <input type="date" class="form-control" id="start_date" v-model="slotForm.start_date" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="end_date" class="form-label">End Date</label>
                                                    <input type="date" class="form-control" id="end_date" v-model="slotForm.end_date" required>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="start_time" class="form-label">Start Time</label>
                                                    <input type="time" class="form-control" id="start_time" v-model="slotForm.start_time" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="end_time" class="form-label">End Time</label>
                                                    <input type="time" class="form-control" id="end_time" v-model="slotForm.end_time" required>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle"></i>
                                            <strong>Note:</strong> This will create 30-minute appointment slots for the specified date range. 
                                            Patients will be able to book these available slots.
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary" :disabled="loading">
                                            <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                            Create Appointment Slots
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Treatment Tab -->
                        <div class="tab-pane fade" id="treatment" role="tabpanel">
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0">Add Treatment Record</h5>
                                </div>
                                <div class="card-body">
                                    <form @submit.prevent="addTreatment">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="appointment_id" class="form-label">Select Appointment</label>
                                                    <select class="form-control" id="appointment_id" v-model="treatmentForm.appointment_id" required>
                                                        <option value="">Select Appointment</option>
                                                        <option v-for="apt in doctorAppointments" :key="apt.id" :value="apt.id">
                                                            {{ apt.patient ? apt.patient.name : 'N/A' }} - {{ apt.appointment_date }} {{ apt.appointment_time }}
                                                        </option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="visit_type" class="form-label">Visit Type</label>
                                                    <select class="form-control" id="visit_type" v-model="treatmentForm.visit_type" required>
                                                        <option value="">Select Type</option>
                                                        <option value="consultation">Consultation</option>
                                                        <option value="follow_up">Follow Up</option>
                                                        <option value="emergency">Emergency</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="symptoms" class="form-label">Symptoms</label>
                                            <textarea class="form-control" id="symptoms" v-model="treatmentForm.symptoms" rows="3" placeholder="Describe patient symptoms"></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="diagnosis" class="form-label">Diagnosis</label>
                                            <textarea class="form-control" id="diagnosis" v-model="treatmentForm.diagnosis" rows="3" placeholder="Enter diagnosis" required></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="prescription" class="form-label">Prescription</label>
                                            <textarea class="form-control" id="prescription" v-model="treatmentForm.prescription" rows="3" placeholder="Enter prescription details"></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="treatment_notes" class="form-label">Treatment Notes</label>
                                            <textarea class="form-control" id="treatment_notes" v-model="treatmentForm.treatment_notes" rows="3" placeholder="Additional treatment notes"></textarea>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary" :disabled="loading">
                                            <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                            Add Treatment Record
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        

                        
                    </div>
                </div>
            </div>

            <!-- Patient Dashboard -->
            <div v-if="currentUser && currentUser.role === 'patient' && appView === 'dashboard'" class="dashboard-container">
                <div class="container">
                    <!-- Welcome Message - Simplified -->
                    <div class="mb-4">
                        <h3 class="text-primary mb-2">Welcome, {{ currentUser.name || currentUser.username }}!</h3>
                        <p class="text-muted fs-5">Here are your upcoming appointments.</p>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.upcoming_appointments || 0 }}</h4>
                                    <p class="mb-0">Upcoming Appointments</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.total_appointments || 0 }}</h4>
                                    <p class="mb-0">Total Appointments</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.doctors_visited || 0 }}</h4>
                                    <p class="mb-0">Doctors Visited</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="patientTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="dept-tab" data-bs-toggle="tab" data-bs-target="#patient-departments" type="button" role="tab">
                                <i class="bi bi-building"></i> Departments
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="book-tab" data-bs-toggle="tab" data-bs-target="#book" type="button" role="tab">
                                <i class="bi bi-calendar-plus"></i> Book Appointment
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#patient-appointments" type="button" role="tab">
                                <i class="bi bi-calendar"></i> My Appointments
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                                <i class="bi bi-clock-history"></i> Past Appointments
                            </button>
                        </li>
                        
                    </ul>

                    <div class="tab-content" id="patientTabsContent">
                        <!-- Patient Departments Tab -->
                        <div class="tab-pane fade" id="patient-departments" role="tabpanel">
                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Departments</h5>
                                    <button class="btn btn-sm btn-outline-secondary" @click="loadPatientData()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="row" v-if="departments.length">
                                        <div class="col-md-6 mb-3" v-for="dept in departments" :key="dept.id">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h6 class="card-title">{{ dept.name }}</h6>
                                                    <p class="card-text small text-muted">{{ dept.description || '—' }}</p>
                                                    <div>
                                                        <strong>Doctors:</strong>
                                                        <ul class="small mb-0" v-if="dept.doctors && dept.doctors.length">
                                                            <li v-for="doc in dept.doctors" :key="doc.id">Dr. {{ doc.name }} ({{ doc.specialization }})</li>
                                                        </ul>
                                                        <p v-else class="small text-muted mb-0">No doctors listed</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else class="text-muted">No departments found.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Book Appointment Tab -->
                        <div class="tab-pane fade show active" id="book" role="tabpanel">
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0">Book New Appointment</h5>
                                </div>
                                <div class="card-body">
                                    <form @submit.prevent="bookAppointment">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="specialization" class="form-label">Department</label>
                                                    <select class="form-control" id="specialization" v-model="selectedDepartment" @change="selectDepartment(selectedDepartment)" required>
                                                        <option value="">Select Department</option>
                                                        <option v-for="dept in departments" :key="dept.id" :value="dept">
                                                            {{ dept.name }} ({{ dept.doctor_count }} doctors)
                                                        </option>
                                                    </select>
                                                    <div v-if="selectedDepartment" class="mt-2">
                                                        <small class="text-muted">
                                                            <strong>Description:</strong> {{ selectedDepartment.description || 'No description available' }}
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="doctor_id" class="form-label">Doctor</label>
                                                    <select class="form-control" id="doctor_id" v-model="selectedDoctor" @change="selectDoctor(selectedDoctor)" required>
                                                        <option value="">Select Doctor</option>
                                                        <option v-for="doctor in availableDoctors" :key="doctor.id" :value="doctor">
                                                            Dr. {{ doctor.name }} - {{ doctor.specialization }}
                                                        </option>
                                                    </select>
                                                    <div v-if="selectedDoctor" class="mt-2">
                                                        <small class="text-muted">
                                                            <strong>Experience:</strong> {{ selectedDoctor.experience }} years | 
                                                            <strong>Fee:</strong> ${{ selectedDoctor.consultation_fee }} | 
                                                            <strong>Qualification:</strong> {{ selectedDoctor.qualification }}
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="appointment_date" class="form-label">Date</label>
                                                    <input type="date" class="form-control" id="appointment_date" v-model="bookingForm.appointment_date" @change="loadAvailableSlots" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="appointment_time" class="form-label">Available Time Slots</label>
                                                    <select class="form-control" id="appointment_time" v-model="bookingForm.appointment_time" required>
                                                        <option value="">Select Available Time</option>
                                                        <option v-for="slot in availableSlots" :key="slot.id" :value="slot.time" :disabled="slot.status === 'booked'">
                                                            {{ slot.time }} - {{ slot.status === 'available' ? 'Available' : 'Booked' }}
                                                        </option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Available Slots Display -->
                                        <div v-if="availableSlots.length > 0" class="mb-3">
                                            <h6>Available Time Slots:</h6>
                                            <div class="row">
                                                <div v-for="slot in availableSlots" :key="slot.id" class="col-md-3 mb-2">
                                                    <button type="button" 
                                                            class="btn btn-sm w-100" 
                                                            :class="slot.status === 'available' ? 'btn-success' : 'btn-secondary'"
                                                            :disabled="slot.status === 'booked'"
                                                            @click="bookingForm.appointment_time = slot.time">
                                                        {{ slot.time }}
                                                        <br>
                                                        <small>{{ slot.status === 'available' ? 'Available' : 'Booked' }}</small>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="notes" class="form-label">Notes (Optional)</label>
                                            <textarea class="form-control" id="notes" v-model="bookingForm.notes" rows="3" placeholder="Any additional notes for the doctor"></textarea>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary" :disabled="loading">
                                            <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                            Book Appointment
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Appointments Tab -->
                        <div class="tab-pane fade" id="patient-appointments" role="tabpanel">
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0">My Appointments</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Doctor</th>
                                                    <th>Specialization</th>
                                                    <th>Date</th>
                                                    <th>Time</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="appointment in patientAppointments" :key="appointment.id">
                                                    <td>{{ appointment.doctor ? appointment.doctor.name : 'N/A' }}</td>
                                                    <td>{{ appointment.doctor ? appointment.doctor.specialization : 'N/A' }}</td>
                                                    <td>{{ appointment.appointment_date }}</td>
                                                    <td>{{ appointment.appointment_time }}</td>
                                                    <td>
                                                        <span class="badge" :class="getStatusClass(appointment.status)">
                                                            {{ appointment.status }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <button v-if="appointment.status === 'booked'" 
                                                                class="btn btn-sm btn-danger" 
                                                                @click="cancelPatientAppointment(appointment.id)">
                                                            <i class="bi bi-x"></i> Cancel
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- History Tab -->
                        <div class="tab-pane fade" id="history" role="tabpanel">
                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Past Appointments</h5>
                                    <button class="btn btn-success btn-sm" @click="exportHistory">
                                        <i class="bi bi-download"></i> Export CSV
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div v-if="treatments.length === 0" class="text-center py-4">
                                        <i class="bi bi-file-medical icon-3x text-muted mb-3"></i>
                                        <p class="text-muted">No medical history available</p>
                                    </div>
                                    <div v-else>
                                        <div v-for="treatment in treatments" :key="treatment.id" class="card mb-3">
                                            <div class="card-header">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <strong>Visit Date:</strong> {{ treatment.created_at }}
                                                    </div>
                                                    <div class="col-md-6">
                                                        <strong>Visit Type:</strong> {{ treatment.visit_type }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h6>Symptoms:</h6>
                                                        <p>{{ treatment.symptoms || 'Not specified' }}</p>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6>Diagnosis:</h6>
                                                        <p>{{ treatment.diagnosis || 'Not specified' }}</p>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h6>Prescription:</h6>
                                                        <p>{{ treatment.prescription || 'Not specified' }}</p>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6>Treatment Notes:</h6>
                                                        <p>{{ treatment.treatment_notes || 'Not specified' }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Doctor Modal -->
        <div class="modal fade" id="addDoctorModal" tabindex="-1" aria-labelledby="addDoctorModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addDoctorModalLabel">Add New Doctor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="addDoctor">
                            <div class="mb-3">
                                <label for="new_username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="new_username" v-model="newDoctor.username" required>
                            </div>
                            <div class="mb-3">
                                <label for="new_email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="new_email" v-model="newDoctor.email" required>
                            </div>
                            <div class="mb-3">
                                <label for="new_password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="new_password" v-model="newDoctor.password" required>
                            </div>
                            <div class="mb-3">
                                <label for="new_name" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="new_name" v-model="newDoctor.name" required>
                            </div>
                            <div class="mb-3">
                                <label for="new_specialization" class="form-label">Specialization</label>
                                <input type="text" class="form-control" id="new_specialization" v-model="newDoctor.specialization" required>
                            </div>
                            <div class="mb-3">
                                <label for="new_experience" class="form-label">Experience (years)</label>
                                <input type="number" class="form-control" id="new_experience" v-model="newDoctor.experience" min="0">
                            </div>
                            <div class="mb-3">
                                <label for="new_phone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="new_phone" v-model="newDoctor.phone">
                            </div>
                            <div class="mb-3">
                                <label for="new_qualification" class="form-label">Qualification</label>
                                <input type="text" class="form-control" id="new_qualification" v-model="newDoctor.qualification">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" @click="addDoctor" :disabled="loading">
                            <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                            Add Doctor
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient History Modal -->
    <div class="modal fade" id="patientHistoryModal" tabindex="-1" aria-labelledby="patientHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="patientHistoryModalLabel">
                        Patient History - {{ selectedPatientHistory ? selectedPatientHistory.name : '' }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" v-if="selectedPatientHistory">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Name:</strong> {{ selectedPatientHistory.name }}
                        </div>
                        <div class="col-md-6">
                            <strong>Email:</strong> {{ selectedPatientHistory.email }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Phone:</strong> {{ selectedPatientHistory.phone }}
                        </div>
                        <div class="col-md-6">
                            <strong>Gender:</strong> {{ selectedPatientHistory.gender }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Date of Birth:</strong> {{ selectedPatientHistory.date_of_birth }}
                        </div>
                        <div class="col-md-6">
                            <strong>Address:</strong> {{ selectedPatientHistory.address }}
                        </div>
                    </div>
                    <div class="mb-3" v-if="selectedPatientHistory.medical_history">
                        <strong>Medical History:</strong>
                        <p class="mt-2">{{ selectedPatientHistory.medical_history }}</p>
                    </div>
                    
                    <h6 class="mt-4 mb-3">Appointment History</h6>
                    <div class="table-responsive" v-if="selectedPatientHistory.appointments && selectedPatientHistory.appointments.length > 0">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                    <th>Diagnosis</th>
                                    <th>Prescription</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="appointment in selectedPatientHistory.appointments" :key="appointment.id">
                                    <td>{{ appointment.appointment_date }}</td>
                                    <td>{{ appointment.appointment_time }}</td>
                                    <td>
                                        <span class="badge" :class="getStatusClass(appointment.status)">
                                            {{ appointment.status }}
                                        </span>
                                    </td>
                                    <td>{{ appointment.treatment ? appointment.treatment.diagnosis : '-' }}</td>
                                    <td>{{ appointment.treatment ? appointment.treatment.prescription : '-' }}</td>
                                    <td>{{ appointment.treatment ? appointment.treatment.notes : '-' }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div v-else>
                        <p class="text-muted">No appointment history found.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/services/api.js"></script>
    <!-- Vue CDN modules (utils, admin/doctor/patient logic) -->
    <script src="/static/js/modules/utils.js"></script>
    <script src="/static/js/modules/admin.js"></script>
    <script src="/static/js/modules/doctor.js"></script>
    <script src="/static/js/modules/patient.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
