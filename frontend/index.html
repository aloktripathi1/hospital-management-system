<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediHub – Hospital Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/custom.css" rel="stylesheet">
    <style>
        /* css to prevent vuejs template flashing issue */
        [v-cloak] {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary" v-if="currentUser">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-hospital"></i> MediHub
                </a>
                <div class="navbar-nav ms-auto">
                    <button v-if="currentUser && currentUser.role !== 'admin'" 
                            class="btn btn-outline-light btn-sm me-2" 
                            @click="openProfilePage()">
                        <i class="bi bi-person-gear"></i> Edit Profile
                    </button>
                    <button class="btn btn-outline-light btn-sm" @click="logout">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid" :class="{'pt-4': currentUser}">
            <!-- Messages -->
            <div v-if="error" class="alert alert-danger alert-dismissible fade show m-3">
                {{ error }}
                <button type="button" class="btn-close" @click="error = null"></button>
            </div>
            <div v-if="success" class="alert alert-success alert-dismissible fade show m-3">
                {{ success }}
                <button type="button" class="btn-close" @click="success = null"></button>
            </div>

            <!-- Homepage -->
            <div v-if="!currentUser && currentView === 'home'" class="homepage">
                <div class="hero-section d-flex align-items-center justify-content-center min-vh-100 bg-primary text-white">
                    <div class="container">
                        <div class="row justify-content-center">
                            <div class="col-lg-8 col-md-10 text-center">
                                <!-- Hospital Logo/Name -->
                                <div class="mb-4">
                                    <i class="bi bi-hospital icon-4x mb-3"></i>
                                    <h1 class="display-3 fw-bold mb-0">MediHub</h1>
                                </div>
                                
                                <!-- Tagline -->
                                <h2 class="h4 fw-light mb-4">
                                    "Seamless Hospital Management, Simplified"
                                </h2>
                                
                                <!-- Description -->
                                <p class="lead mb-5">
                                    Manage doctors, patients, appointments, and treatments<br>
                                    efficiently—all in one place.
                                </p>
                                
                                <!-- Action Buttons -->
                                <div class="d-flex gap-3 justify-content-center">
                                    <button class="btn btn-light btn-lg px-4 py-3" @click="currentView = 'login'">
                                        <i class="bi bi-box-arrow-in-right me-2"></i>Login
                                    </button>
                                    <button class="btn btn-outline-light btn-lg px-4 py-3" @click="currentView = 'register'">
                                        <i class="bi bi-person-plus me-2"></i>Register
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- profile edit -->
            <div v-if="currentUser && appView === 'profile'" class="container my-4">
                <button class="btn btn-outline-secondary mb-3" @click="openDashboard()">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </button>
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <i class="bi bi-person-gear me-2"></i>
                        <h5 class="mb-0">Edit Profile</h5>
                    </div>
                    <div class="card-body">
                        <form @submit.prevent="updateProfile">
                            <div class="row">
                                <div class="col-md-6" v-if="currentUser.role === 'doctor'">
                                    <div class="mb-3">
                                        <label for="profile_name" class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="profile_name" v-model="profileForm.name" required>
                                    </div>
                                </div>
                                <div class="col-md-6" v-if="currentUser.role === 'patient'">
                                    <div class="mb-3">
                                        <label for="patient_name" class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="patient_name" v-model="profileForm.name" required>
                                    </div>
                                </div>
                                <div class="col-md-6" v-if="currentUser.role === 'patient'">
                                    <div class="mb-3">
                                        <label for="patient_email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="patient_email" v-model="profileForm.email" required>
                                    </div>
                                </div>
                                <div class="col-md-6" v-if="currentUser.role === 'doctor'">
                                    <div class="mb-3">
                                        <label for="profile_department" class="form-label">Department</label>
                                        <input type="text" class="form-control" id="profile_department" v-model="profileForm.department" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="profile_phone" class="form-label">Phone</label>
                                        <input type="tel" class="form-control" id="profile_phone" v-model="profileForm.phone">
                                    </div>
                                </div>
                                <div class="col-md-6" v-if="currentUser.role === 'doctor'">
                                    <div class="mb-3">
                                        <label for="profile_experience" class="form-label">Experience (years)</label>
                                        <input type="number" class="form-control" id="profile_experience" v-model="profileForm.experience" min="0" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row" v-if="currentUser.role === 'doctor'">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="profile_qualification" class="form-label">Qualification</label>
                                        <input type="text" class="form-control" id="profile_qualification" v-model="profileForm.qualification" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="profile_consultation_fee" class="form-label">Consultation Fee</label>
                                        <input type="number" step="0.01" class="form-control" id="profile_consultation_fee" v-model="profileForm.consultation_fee" required>
                                    </div>
                                </div>
                            </div>

                            <div class="row" v-if="currentUser.role === 'patient'">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="patient_age" class="form-label">Age</label>
                                        <input type="number" class="form-control" id="patient_age" v-model="profileForm.age" min="0" max="120">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="patient_gender" class="form-label">Gender</label>
                                        <select class="form-select" id="patient_gender" v-model="profileForm.gender">
                                            <option value="">Select Gender</option>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row" v-if="currentUser.role === 'patient'">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label for="patient_address" class="form-label">Address</label>
                                        <textarea class="form-control" id="patient_address" v-model="profileForm.address" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                Save Changes
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- login and registration form -->
            <div v-if="!currentUser && (currentView === 'login' || currentView === 'register')" class="auth-container">
                <div class="container">
                    <div class="row justify-content-center align-items-center min-vh-100">
                        <div class="col-md-6 col-lg-5">
                            <div class="auth-form">
                                <div class="p-4">
                                    <!-- login form -->
                                    <div v-if="currentView === 'login'">
                                        <div class="text-center mb-4">
                                            <h3 class="mb-2">Sign In</h3>
                                            <p class="text-muted">Welcome to MediHub</p>
                                        </div>
                                        <form @submit.prevent="handleLogin">
                                            <div class="mb-3">
                                                <label for="username" class="form-label">Username</label>
                                                <input type="text" class="form-control" id="username" v-model="loginForm.username" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="password" class="form-label">Password</label>
                                                <input type="password" class="form-control" id="password" v-model="loginForm.password" required>
                                            </div>
                                            <button type="submit" class="btn btn-primary w-100 mb-3" :disabled="loading">
                                                Sign In
                                            </button>
                                        </form>
                                        <div class="text-center">
                                            <p class="mb-0">Don't have an account? 
                                                <a href="#" @click.prevent="currentView = 'register'" class="text-primary">Register</a>
                                            </p>
                                        </div>
                                        <div class="mt-4 p-3 bg-light rounded">
                                            <small class="text-muted">
                                                <strong>Demo Accounts:</strong><br>
                                                Admin: admin / admin<br>
                                                Doctor: dr_rahul / rahul<br>
                                                Patient: arjun / arjun
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- Registration Form -->
                                    <div v-if="currentView === 'register'">
                                        <div class="text-center mb-4">
                                            <!-- <i class="bi bi-person-plus fs-1 text-primary mb-3"></i> -->
                                            <h3 class="mb-2">Register</h3>
                                            <p class="text-muted">Create your patient account</p>
                                        </div>
                                        <form @submit.prevent="handleRegister">
                                            <div class="mb-3">
                                                <label for="reg_name" class="form-label">Name</label>
                                                <input type="text" class="form-control" id="reg_name" v-model="registerForm.name" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="reg_email" class="form-label">Email Id</label>
                                                <input type="email" class="form-control" id="reg_email" v-model="registerForm.email" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="reg_username" class="form-label">Username</label>
                                                <input type="text" class="form-control" id="reg_username" v-model="registerForm.username" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="reg_password" class="form-label">Password</label>
                                                <input type="password" class="form-control" id="reg_password" v-model="registerForm.password" required>
                                            </div>
                                            <button type="submit" class="btn btn-primary w-100 mb-3" :disabled="loading">
                                                Sign In
                                            </button>
                                        </form>
                                        <div class="text-center">
                                            <p class="mb-0">Already have an account? 
                                                <a href="#" @click.prevent="currentView = 'login'" class="text-primary">Sign In</a>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div v-if="currentUser && currentUser.role === 'admin' && appView === 'dashboard'" class="dashboard-container">
                <div class="container">
                    <!-- Welcome Message - Only show on main dashboard -->
                    <div v-if="adminView === 'dashboard'" class="mb-4">
                        <h3 class="text-primary mb-2">Welcome Admin !</h3>
                        <p class="text-muted fs-5">Manage doctors, patients, and appointments efficiently.</p>
                    </div>

                    <!-- Navigation -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <button v-if="adminView !== 'dashboard'" class="btn btn-outline-secondary mb-2" @click="adminView = 'dashboard'">
                                <i class="bi bi-arrow-left"></i> Back to Dashboard
                            </button>
                        </div>
                    </div>

                    <!-- Dashboard View -->
                    <div v-if="adminView === 'dashboard'">
                    
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.total_doctors || 0 }}</h4>
                                    <p class="mb-0">Total Doctors</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.total_patients || 0 }}</h4>
                                    <p class="mb-0">Total Patients</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.total_appointments || 0 }}</h4>
                                    <p class="mb-0">Total Appointments</p>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Tabs -->
                    <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="doctors-tab" data-bs-toggle="tab" data-bs-target="#doctors" type="button" role="tab">
                                <i class="bi bi-person-badge"></i> Doctors
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="patients-tab" data-bs-toggle="tab" data-bs-target="#patients" type="button" role="tab">
                                <i class="bi bi-people"></i> Patients
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#appointments" type="button" role="tab">
                                <i class="bi bi-calendar"></i> Appointments
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="adminTabsContent">
                        <!-- Doctors Tab -->
                        <div class="tab-pane fade show active" id="doctors" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Manage Doctors</h5>
                                    <button class="btn btn-outline-primary" @click="showAddDoctorForm">
                                        <i class="bi bi-plus"></i> Add Doctor
                                    </button>
                                    <!-- <button class="btn btn-primary btn-sm" @click="showAddDoctorForm()">
                                        <i class="bi bi-plus-circle me-1"></i>Add Doctor
                                    </button> -->
                                </div>
                                <div class="card-body">
                                    <!-- Search Form -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <input type="text" class="form-control" placeholder="Search doctors by name or department..." v-model="doctorSearchQuery" @input="searchDoctors">
                                                <button class="btn btn-outline-secondary" type="button" @click="clearDoctorSearch">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="table-responsive mb-3">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Sr. No.</th>
                                                    <th>Name</th>
                                                    <th>Specialization</th>
                                                    <th>Experience</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(doctor, index) in filteredDoctors" :key="doctor.id">
                                                    <td>{{ index + 1 }}.</td>
                                                    <td>Dr. {{ doctor.name }}</td>
                                                    <td>{{ doctor.specialization }}</td>
                                                    <td>{{ doctor.experience }} years</td>
                                                    <td>
                                                        <span class="badge" :class="doctor.is_active ? 'bg-success' : 'bg-danger'">
                                                            {{ doctor.is_active ? 'Active' : 'Inactive' }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-info me-1" @click="editDoctor(doctor)" title="Edit Doctor">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button class="btn btn-sm" :class="doctor.is_active ? 'btn-outline-warning' : 'btn-outline-success'" @click="toggleDoctorStatus(doctor)" :title="doctor.is_active ? 'Blacklist Doctor' : 'Activate Doctor'">
                                                            <i class="bi" :class="doctor.is_active ? 'bi-ban' : 'bi-check-circle'"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Patients Tab -->
                        <div class="tab-pane fade" id="patients" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Manage Patients</h5>
                                </div>
                                <div class="card-body">
                                    <!-- Search Form -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <input type="text" class="form-control" placeholder="Search patients by name..." v-model="patientSearchQuery" @input="searchPatients">
                                                <button class="btn btn-outline-secondary" type="button" @click="clearPatientSearch">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive mb-3">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Sr. No</th>
                                                    <th>Name</th>
                                                    <th>Email</th>
                                                    <th>Phone</th>
                                                    <th>Age</th>
                                                    <th>Gender</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(patient, index) in filteredPatients" :key="patient.id" :class="{ 'table-danger': patient.is_blacklisted }">
                                                    <td>{{ index + 1 }}.</td>
                                                    <td>
                                                        {{ getPatientPrefix() }}{{ patient.name }}
                                                        <span v-if="patient.is_blacklisted" class="badge bg-danger ms-2">Blacklisted</span>
                                                    </td>
                                                    <td>{{ patient.user ? patient.user.email : 'N/A' }}</td>
                                                    <td>{{ patient.phone }}</td>
                                                    <td>{{ patient.age }}</td>
                                                    <td>{{ patient.gender }}</td>
                                                    <td>
                                                        <button class="btn btn-sm me-1" :class="patient.is_blacklisted ? 'btn-outline-success' : 'btn-outline-warning'" @click="togglePatientBlacklist(patient)" title="Blacklist/Unblacklist Patient">
                                                            <i class="bi" :class="patient.is_blacklisted ? 'bi-check-circle' : 'bi-ban'"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-primary" @click="openAdminPatientHistory(patient)" title="View Patient History">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Appointments Tab -->
                        <div class="tab-pane fade" id="appointments" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">All Appointments</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive mb-3">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Sr. No</th>
                                                    <th>Patient</th>
                                                    <th>Doctor</th>
                                                    <th>Department</th>
                                                    <th>Date</th>
                                                    <th>Slot</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                                <tr v-for="(appointment, index) in filteredAppointments" :key="appointment.id">
                                                    <td>{{ index + 1 }}.</td>
                                                    <td>{{ getPatientPrefix() }}{{ appointment.patient ? appointment.patient.name : 'N/A' }}</td>
                                                    <td>Dr. {{ appointment.doctor ? appointment.doctor.name : 'N/A' }}</td>
                                                    <td>{{ appointment.doctor ? appointment.doctor.department : 'N/A' }}</td>
                                                    <td>{{ appointment.appointment_date }}</td>
                                                    <td>{{ formatTimeSlot(appointment.appointment_time) }}</td>
                                                    <td>
                                                        <span class="badge" :class="getStatusClass(appointment.status)">
                                                            {{ appointment.status }}
                                                        </span>
                                                    </td>
                                                </tr>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>

                    <!-- Add Doctor Page -->
                    <div v-if="adminView === 'add-doctor'" class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Add New Doctor</h5>
                        </div>
                        <div class="card-body">
                            <form @submit.prevent="addDoctor">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_name" class="form-label">Full Name</label>
                                            <input type="text" class="form-control" id="new_name" v-model="newDoctor.name" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_email" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="new_email" v-model="newDoctor.email" required>
                                            <small class="text-muted">Login credentials will be auto-generated</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_specialization" class="form-label">Specialization</label>
                                            <select class="form-select" id="new_specialization" v-model="newDoctor.specialization" required>
                                                <option value="">Select Specialization</option>
                                                <option value="Cardiology">Cardiology</option>
                                                <option value="Neurology">Neurology</option>
                                                <option value="Orthopedics">Orthopedics</option>
                                                <option value="Pediatrics">Pediatrics</option>
                                                <option value="Dermatology">Dermatology</option>
                                                <option value="Psychiatry">Psychiatry</option>
                                                <option value="General Medicine">General Medicine</option>
                                                <option value="ENT">ENT</option>
                                                <option value="Ophthalmology">Ophthalmology</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_experience" class="form-label">Experience (years)</label>
                                            <input type="number" class="form-control" id="new_experience" v-model="newDoctor.experience" min="0" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_phone" class="form-label">Phone</label>
                                            <input type="tel" class="form-control" id="new_phone" v-model="newDoctor.phone" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_qualification" class="form-label">Qualification</label>
                                            <input type="text" class="form-control" id="new_qualification" v-model="newDoctor.qualification" required>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary" :disabled="loading">
                                    <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                    Add Doctor
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- edit doctor -->
                    <div v-if="adminView === 'edit-doctor'" class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Edit Doctor: {{ editingDoctor.name }}</h5>
                        </div>
                        <div class="card-body">
                            <form @submit.prevent="updateDoctor">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_name" class="form-label">Full Name</label>
                                            <input type="text" class="form-control" id="edit_name" v-model="editingDoctor.name" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_specialization" class="form-label">Specialization</label>
                                            <select class="form-select" id="edit_specialization" v-model="editingDoctor.specialization" required>
                                                <option value="">Select Specialization</option>
                                                <option value="Cardiology">Cardiology</option>
                                                <option value="Neurology">Neurology</option>
                                                <option value="Orthopedics">Orthopedics</option>
                                                <option value="Pediatrics">Pediatrics</option>
                                                <option value="Dermatology">Dermatology</option>
                                                <option value="Psychiatry">Psychiatry</option>
                                                <option value="General Medicine">General Medicine</option>
                                                <option value="ENT">ENT</option>
                                                <option value="Ophthalmology">Ophthalmology</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_experience" class="form-label">Experience (years)</label>
                                            <input type="number" class="form-control" id="edit_experience" v-model="editingDoctor.experience" min="0" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_phone" class="form-label">Phone</label>
                                            <input type="tel" class="form-control" id="edit_phone" v-model="editingDoctor.phone" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_qualification" class="form-label">Qualification</label>
                                            <input type="text" class="form-control" id="edit_qualification" v-model="editingDoctor.qualification" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_consultation_fee" class="form-label">Consultation Fee</label>
                                            <input type="number" step="0.01" class="form-control" id="edit_consultation_fee" v-model="editingDoctor.consultation_fee" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_is_active" v-model="editingDoctor.is_active">
                                        <label class="form-check-label" for="edit_is_active">
                                            Active Doctor
                                        </label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary" :disabled="loading">
                                    <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                    Update Doctor
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Patient History View -->
                    <div v-if="adminView === 'patient-history'" class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-clock-history"></i> Patient History - {{ selectedPatient?.name }}
                                </h5>
                                <span class="badge bg-info">{{ patientHistory.length }} appointments</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div v-if="patientHistory.length === 0" class="text-center text-muted py-4">
                                <i class="bi bi-clock-history icon-3x mb-3"></i>
                                <p>No booked appointments found for this patient.</p>
                                <small class="text-muted">Only showing appointments that are booked, completed, or cancelled.</small>
                            </div>
                            <div v-else class="table-responsive mb-3">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Sr. No</th>
                                            <th>Date</th>
                                            <th>Slot</th>
                                            <th>Doctor</th>
                                            <th>Department</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(appointment, index) in patientHistory" :key="appointment.id">
                                            <td>{{ index + 1 }}.</td>
                                            <td>{{ new Date(appointment.appointment_date).toLocaleDateString() }}</td>
                                            <td>{{ formatTimeSlot(appointment.appointment_time) }}</td>
                                            <td>Dr. {{ appointment.doctor?.name || 'N/A' }}</td>
                                            <td>{{ appointment.doctor?.department || 'N/A' }}</td>
                                            <td>
                                                <span class="badge" :class="getStatusClass(appointment.status)">
                                                    {{ appointment.status }}
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Doctor Dashboard -->
            <div v-if="currentUser && currentUser.role === 'doctor' && appView === 'dashboard'" class="dashboard-container">
                <div class="container">
                    <!-- Welcome Message -->
                    <div class="mb-4">
                        <h3 class="text-primary mb-2">Welcome, Dr. {{ currentUser.name || currentUser.username }}!</h3>
                        <p class="text-muted fs-5">Here are your appointments for today.</p>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.total_appointments || 0 }}</h4>
                                    <p class="mb-0">Total Appointments</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.total_patients || 0 }}</h4>
                                    <p class="mb-0">Total Patients</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.today_appointments || 0 }}</h4>
                                    <p class="mb-0">Today's Appointments</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs mb-3" id="doctorTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#doctor-appointments" type="button" role="tab">
                                <i class="bi bi-calendar"></i> Appointments
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="patients-tab" data-bs-toggle="tab" data-bs-target="#doctor-patients" type="button" role="tab">
                                <i class="bi bi-people"></i> Assigned Patients
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="availability-tab" data-bs-toggle="tab" data-bs-target="#availability" type="button" role="tab">
                                <i class="bi bi-calendar-alt"></i> Set Availability
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="doctorTabsContent">
                        <!-- Appointments Tab -->
                        <div class="tab-pane fade show active" id="doctor-appointments" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Appointments</h5>
                                </div>
                                <div class="card-body">
                                    <div v-if="doctorAppointments.length === 0" class="text-center py-4">
                                        <i class="bi bi-calendar-x display-1 text-muted mb-3"></i>
                                        <p class="text-muted">No appointments found</p>
                                    </div>
                                    <div v-else class="table-responsive mb-3">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Sr. No</th>
                                                    <th>Patient</th>
                                                    <th>Date</th>
                                                    <th>Slot</th>
                                                    <th>Age / Gender</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="appointment in doctorAppointments" :key="appointment.id">
                                                    <td>{{ appointment.sr_no }}.</td>
                                                    <td>{{ getPatientPrefix() }}{{ appointment.patient ? appointment.patient.name : 'N/A' }}</td>
                                                    <td>{{ appointment.appointment_date }}</td>
                                                    <td>{{ formatTimeSlot(appointment.appointment_time) }}</td>
                                                    <td>{{ appointment.patient ? appointment.patient.age : 'N/A' }} / {{ appointment.patient ? appointment.patient.gender : 'N/A' }}</td>
                                                    <td>
                                                        <span class="badge" :class="getStatusClass(appointment.status)">
                                                            {{ appointment.status }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary me-1" 
                                                                @click="openTreatmentPage(appointment)" 
                                                                title="Update Treatment">
                                                            <i class="bi bi-pencil-square"></i> Update
                                                        </button>
                                                        <button v-if="appointment.status === 'booked'"
                                                                class="btn btn-sm btn-outline-warning" 
                                                                @click="cancelDoctorAppointment(appointment.id)" 
                                                                title="Cancel Appointment">
                                                            <i class="bi bi-x-circle"></i> Cancel
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Assigned Patients Tab -->
                        <div class="tab-pane fade" id="doctor-patients" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Assigned Patients</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive mb-3">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Sr. No</th>
                                                    <th>Name</th>
                                                    <th>Phone</th>
                                                    <th>Age</th>
                                                    <th>Gender</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="patient in doctorPatients" :key="patient.id">
                                                    <td>{{ patient.sr_no }}.</td>
                                                    <td>{{ patient.name }}</td>
                                                    <td>{{ patient.phone }}</td>
                                                    <td>{{ patient.age }}</td>
                                                    <td>{{ patient.gender }}</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary" 
                                                                @click="viewPatientTreatmentHistory(patient)" 
                                                                title="View Treatment History">
                                                            <i class="bi bi-eye"></i> View History
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Availability Tab -->
                        <div class="tab-pane fade" id="availability" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Set Availability (Next 7 Days)</h5>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted mb-4">Check the boxes for slots when you're available. Morning: 9 AM - 1 PM, Evening: 3 PM - 7 PM</p>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 40%">Date</th>
                                                    <th style="width: 30%">Morning (9 AM - 1 PM)</th>
                                                    <th style="width: 30%">Evening (3 PM - 7 PM)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="day in availabilityDays" :key="day.date">
                                                    <td><strong>{{ day.day_name }}</strong></td>
                                                    <td class="text-center">
                                                        <div class="form-check d-inline-block">
                                                            <input 
                                                                class="form-check-input" 
                                                                type="checkbox" 
                                                                :id="'morning-' + day.date"
                                                                v-model="day.morning_available">
                                                            <label class="form-check-label" :for="'morning-' + day.date">
                                                                Available
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="form-check d-inline-block">
                                                            <input 
                                                                class="form-check-input" 
                                                                type="checkbox" 
                                                                :id="'evening-' + day.date"
                                                                v-model="day.evening_available">
                                                            <label class="form-check-label" :for="'evening-' + day.date">
                                                                Available
                                                            </label>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="alert alert-info mt-3">
                                        <i class="bi bi-info-circle"></i> <strong>Note:</strong> Patients will be able to book appointments for the slots you mark as available.
                                    </div>
                                    
                                    <button @click="saveAvailability" class="btn btn-primary" :disabled="loading">
                                        <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                        <i class="bi bi-calendar-check"></i> Save Availability
                                    </button>
                                </div>
                            </div>
                        </div>

                        
                    </div>
                </div>
            </div>

        <!-- Treatment Management Page -->
        <div v-if="currentUser && currentUser.role === 'doctor' && appView === 'treatment-management'" class="container mt-4">
            <div class="row justify-content-center">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Manage Treatment - {{ selectedAppointmentForTreatment?.patient?.name }}</h5>
                            <button class="btn btn-outline-secondary mb-2" @click="backToDoctorAppointments()">
                                <i class="bi bi-arrow-left"></i> Back to Dashboard
                            </button> 
                        </div>
                        <div class="card-body">
                            <div v-if="selectedAppointmentForTreatment">
                                <!-- Appointment Info -->
                                <div class="alert alert-light mb-4">
                                    <strong>Appointment:</strong> {{ selectedAppointmentForTreatment.appointment_date }} at {{ selectedAppointmentForTreatment.appointment_time }}
                                    <br><strong>Status:</strong> {{ selectedAppointmentForTreatment.status }}
                                </div>

                                <!-- Treatment Form -->
                                <form @submit.prevent="submitTreatment">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Visit Type <span class="text-danger">*</span></label>
                                            <select class="form-select" v-model="treatmentForm.visit_type" required>
                                                <option value="">Select Visit Type</option>
                                                <option value="consultation">Consultation</option>
                                                <option value="follow_up">Follow Up</option>
                                                <option value="emergency">Emergency</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Diagnosis <span class="text-danger">*</span></label>
                                        <textarea class="form-control" rows="3" v-model="treatmentForm.diagnosis" 
                                                placeholder="Provide the diagnosis" required></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Prescribed Medicines <span class="text-danger">*</span></label>
                                        <textarea class="form-control" rows="3" v-model="treatmentForm.prescription" 
                                                placeholder="List prescribed medications with dosage" required></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Treatment Notes <span class="text-danger">*</span></label>
                                        <textarea class="form-control" rows="4" v-model="treatmentForm.treatment_notes" 
                                                placeholder="Additional notes, recommendations, and follow-up instructions" required></textarea>
                                    </div>
                                    
                                    <div class="text-center">
                                        <button type="submit" class="btn btn-primary me-2" :disabled="!isFormComplete()">
                                            Update Treatment
                                        </button>
                                        <button type="button" class="btn btn-success" @click="markAsCompleted()" 
                                                :disabled="!isFormComplete() || selectedAppointmentForTreatment.status === 'completed'">
                                            Mark as Completed
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient Treatment History Page -->
        <div v-if="currentUser && currentUser.role === 'doctor' && appView === 'patient-treatment-history'" class="container mt-4">
            <div class="row justify-content-center">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Treatment History - {{ selectedPatientForHistory?.name }}</h5>
                            <button class="btn btn-outline-secondary mb-2" @click="backToAssignedPatients()">
                                <i class="bi bi-arrow-left"></i> Back to Patients
                            </button> 
                        </div>
                        <div class="card-body">
                            <div v-if="selectedPatientForHistory">
                                <!-- Patient Info -->
                                <div class="alert alert-light mb-4">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>Name:</strong> {{ selectedPatientForHistory.name }}
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Age:</strong> {{ selectedPatientForHistory.age }}
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Gender:</strong> {{ selectedPatientForHistory.gender }}
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Phone:</strong> {{ selectedPatientForHistory.phone }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Treatment History Table -->
                                <div class="table-responsive mb-3" v-if="selectedPatientForHistory.appointments && selectedPatientForHistory.appointments.length > 0">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Date</th>
                                                <th>Slot</th>
                                                <th>Doctor</th>
                                                <th>Status</th>
                                                <th>Visit Type</th>
                                                <th>Diagnosis</th>
                                                <th>Prescription</th>
                                                <th>Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="appointment in selectedPatientForHistory.appointments" :key="appointment.id">
                                                <td>{{ appointment.appointment_date }}</td>
                                                <td>{{ formatTimeSlot(appointment.appointment_time) }}</td>
                                                <td>{{ appointment.doctor ? appointment.doctor.name : '-' }}</td>
                                                <td>
                                                    <span class="badge" :class="getStatusClass(appointment.status)">
                                                        {{ appointment.status }}
                                                    </span>
                                                </td>
                                                <td>{{ appointment.treatment ? appointment.treatment.visit_type : '-' }}</td>
                                                <td>{{ appointment.treatment ? appointment.treatment.diagnosis : '-' }}</td>
                                                <td>{{ appointment.treatment ? appointment.treatment.prescription : '-' }}</td>
                                                <td>{{ appointment.treatment ? appointment.treatment.notes : '-' }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div v-else class="text-center text-muted py-4">
                                    <i class="bi bi-calendar-x fs-1"></i>
                                    <p class="mt-3">No treatment history found for this patient.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <!-- Patient Dashboard -->
            <div v-if="currentUser && currentUser.role === 'patient' && appView === 'dashboard'" class="dashboard-container">
                <div class="container">
                    <!-- Welcome Message - Simplified -->
                    <div class="mb-4">
                        <h3 class="text-primary mb-2">Welcome, {{ currentUser.name || currentUser.username }}!</h3>
                        <p class="text-muted fs-5">Here are your upcoming appointments.</p>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.upcoming_appointments || 0 }}</h4>
                                    <p class="mb-0">Upcoming Appointments</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.total_appointments || 0 }}</h4>
                                    <p class="mb-0">Total Appointments</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4>{{ stats.doctors_visited || 0 }}</h4>
                                    <p class="mb-0">Doctors Visited</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs mb-3" id="patientTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="book-tab" data-bs-toggle="tab" data-bs-target="#book" type="button" role="tab">
                                <i class="bi bi-calendar-plus"></i> Book Appointment
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#patient-appointments" type="button" role="tab">
                                <i class="bi bi-calendar"></i> My Appointments
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#medical-history" type="button" role="tab">
                                <i class="bi bi-journal-medical"></i> Medical History
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="patientTabsContent">
                        <!-- Book Appointment Tab -->
                        <div class="tab-pane fade show active" id="book" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Book New Appointment</h5>
                                </div>
                                <div class="card-body">
                                    <form @submit.prevent="bookAppointment">
                                        <!-- Step 1: Select Specialization -->
                                        <div class="mb-4">
                                            <label class="form-label">Step 1: Select Specialization</label>
                                            <select class="form-select" v-model="selectedDepartment" @change="selectDepartment(selectedDepartment)" required>
                                                <option value="">Choose Specialization</option>
                                                <option v-for="dept in departments" :key="dept.id" :value="dept">
                                                    {{ dept.name }} ({{ dept.doctor_count }} {{ dept.doctor_count === 1 ? 'doctor' : 'doctors' }})
                                                </option>
                                            </select>
                                            <div v-if="selectedDepartment" class="mt-2">
                                                <small class="text-muted">
                                                    <i class="bi bi-info-circle me-1"></i>{{ getSpecializationDescription(selectedDepartment.name) }}
                                                </small>
                                            </div>
                                        </div>

                                        <!-- Step 2: Select Doctor -->
                                        <div v-if="selectedDepartment && selectedDepartment.doctors.length > 0" class="mb-4">
                                            <label class="form-label">Step 2: Select Doctor</label>
                                            <div class="row">
                                                <div v-for="doctor in selectedDepartment.doctors" :key="doctor.id" class="col-md-6 mb-2">
                                                    <button type="button" 
                                                            class="btn w-100 text-start py-2"
                                                            :class="selectedDoctor?.id === doctor.id ? 'btn-primary' : 'btn-outline-primary'"
                                                            @click="selectDoctor(doctor)">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <strong>Dr. {{ doctor.name }}</strong><br>
                                                                <small>{{ doctor.qualification }} • {{ doctor.experience }} yrs</small>
                                                            </div>
                                                            <span v-if="selectedDoctor?.id === doctor.id" class="badge bg-light text-primary">
                                                                <i class="bi bi-check-circle-fill"></i>
                                                            </span>
                                                        </div>
                                                    </button>
                                                </div>
                                            </div>
                                            <div v-if="selectedDoctor" class="mt-2">
                                                <small class="text-muted">
                                                    <i class="bi bi-check-circle me-1"></i>
                                                    Dr. {{ selectedDoctor.name }} {{ selectedDoctor.specialization }}, {{ selectedDoctor.qualification }}, {{ selectedDoctor.experience }} years exp.
                                                </small>
                                            </div>
                                        </div>

                                        <!-- Step 3: Select Date -->
                                        <div v-if="selectedDoctor" class="mb-4">
                                            <label class="form-label">Step 3: Select Date</label>
                                            <input type="date" class="form-control" v-model="bookingForm.appointment_date" @change="loadAvailableSlots" :min="minBookingDate" required>
                                            <small class="text-muted">You cannot book appointments for past dates</small>
                                        </div>

                                        <!-- Step 4: Select Time Slot -->
                                        <div v-if="selectedDoctor && bookingForm.appointment_date" class="mb-4">
                                            <label class="form-label">Step 4: Select Time Slot</label>
                                            <div v-if="availableSlots.length > 0">
                                                <div class="row">
                                                    <div v-for="slot in availableSlots" :key="slot.slot_type" class="col-md-6 mb-2">
                                                        <button type="button" 
                                                                class="btn w-100" 
                                                                :class="[
                                                                    slot.status === 'available' ? 'btn-outline-success' : 'btn-outline-secondary',
                                                                    bookingForm.appointment_time === slot.appointment_time ? 'active bg-success text-white' : ''
                                                                ]"
                                                                :disabled="slot.status !== 'available'"
                                                                @click="bookingForm.appointment_time = slot.appointment_time">
                                                            <div class="py-2">
                                                                <div>
                                                                    <strong>{{ slot.slot_type === 'morning' ? '🌅 Morning' : '🌆 Evening' }}</strong>
                                                                    <span class="ms-2 badge" :class="slot.status === 'available' ? 'bg-success' : 'bg-danger'">
                                                                        {{ slot.status === 'available' ? '✓' : '✗' }}
                                                                    </span>
                                                                </div>
                                                                <small>{{ slot.time }}</small>
                                                            </div>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div v-if="bookingForm.appointment_time" class="mt-2">
                                                    <small class="text-success">
                                                        <i class="bi bi-check-circle me-1"></i>
                                                        {{ availableSlots.find(s => s.appointment_time === bookingForm.appointment_time)?.display }}
                                                    </small>
                                                </div>
                                            </div>
                                            <div v-else class="text-warning">
                                                <small>
                                                    <i class="bi bi-info-circle me-1"></i>
                                                    No slots available for this date.
                                                </small>
                                            </div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary" :disabled="loading">
                                            <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                            Book Appointment
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Unified Appointments Tab -->
                        <div class="tab-pane fade" id="patient-appointments" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">My Appointments</h5>
                                </div>
                                <div class="card-body">
                                    <div v-if="allPatientAppointments.length === 0" class="text-center py-4">
                                        <i class="bi bi-calendar-x icon-3x text-muted mb-3"></i>
                                        <p class="text-muted">No appointments found</p>
                                    </div>
                                    <div v-else class="table-responsive mb-3">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Sr. No</th>
                                                    <th>Doctor</th>
                                                    <th>Department</th>
                                                    <th>Date</th>
                                                    <th>Slot</th>
                                                    <th>Status</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(appointment, index) in allPatientAppointments" :key="appointment.id">
                                                    <td>{{ index + 1 }}.</td>
                                                    <td>{{ appointment.doctor ? 'Dr. ' + appointment.doctor.name : 'N/A' }}</td>
                                                    <td>{{ appointment.department || (appointment.doctor ? appointment.doctor.specialization : 'N/A') }}</td>
                                                    <td>{{ appointment.appointment_date }}</td>
                                                    <td>{{ formatTimeSlot(appointment.appointment_time) }}</td>
                                                    <td>
                                                        <span class="badge" :class="getStatusClass(appointment.status)">
                                                            {{ capitalizeStatus(appointment.status) }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <button v-if="appointment.status === 'booked'" 
                                                                class="btn btn-sm btn-outline-warning" 
                                                                @click="cancelPatientAppointment(appointment.id)">
                                                            <i class="bi bi-x"></i>
                                                        </button>
                                                        <button v-else-if="appointment.status === 'cancelled' || appointment.status === 'completed'" 
                                                                class="btn btn-sm btn-outline-primary" 
                                                                @click="showAppointmentHistory(appointment)">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Medical History Tab -->
                        <div class="tab-pane fade" id="medical-history" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">My Medical History</h5>
                                    <div>
                                        <button class="btn btn-success btn-sm" @click="exportHistory">
                                            <i class="bi bi-download"></i> Export Full History
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Empty State -->
                                    <div v-if="treatments.length === 0" class="text-center py-4">
                                        <i class="bi bi-journal-x display-4 text-muted mb-3"></i>
                                        <p class="text-muted">No medical history found</p>
                                        <small class="text-muted">Your completed appointments with treatment details will appear here</small>
                                    </div>
                                    <!-- Medical History Table -->
                                    <div v-else class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Sr. No</th>
                                                    <th>Date</th>
                                                    <th>Doctor</th>
                                                    <th>Visit Type</th>
                                                    <th>Diagnosis</th>
                                                    <th>Prescription</th>
                                                    <th>Treatment Notes</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(treatment, index) in treatments" :key="treatment.id">
                                                    <td>{{ index + 1 }}</td>
                                                    <td>{{ treatment.created_at ? new Date(treatment.created_at).toLocaleDateString() : 'N/A' }}</td>
                                                    <td>{{ getTreatmentDoctor(treatment) }}</td>
                                                    <td>
                                                        <span class="badge bg-info">{{ treatment.visit_type || 'General' }}</span>
                                                    </td>
                                                    <td>{{ truncateText(treatment.diagnosis) }}</td>
                                                    <td>{{ truncateText(treatment.prescription) }}</td>
                                                    <td>{{ truncateText(treatment.treatment_notes) }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>



                        
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient Appointment History View -->
        <div v-if="currentUser && currentUser.role === 'patient' && appView === 'appointment-history'" class="container mt-4">
            <div class="row justify-content-center">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Appointment History Details</h5>
                            <button class="btn btn-outline-secondary mb-2" @click="goBackToAppointments()">
                                <i class="bi bi-arrow-left"></i> Back to Appointments
                            </button> 
                        </div>
                        <div class="card-body">
                            <div v-if="selectedAppointmentHistory">
                                <!-- Appointment Information -->
                                <div class="mb-4">
                                    <h6>Appointment Information</h6>
                                    <p><strong>Doctor:</strong> {{ selectedAppointmentHistory.doctor ? 'Dr. ' + selectedAppointmentHistory.doctor.name : 'N/A' }}</p>
                                    <p><strong>Department:</strong> {{ selectedAppointmentHistory.department || (selectedAppointmentHistory.doctor ? selectedAppointmentHistory.doctor.specialization : 'N/A') }}</p>
                                    <p><strong>Date:</strong> {{ selectedAppointmentHistory.appointment_date }}</p>
                                    <p><strong>Time:</strong> {{ selectedAppointmentHistory.appointment_time }}</p>
                                    <p><strong>Status:</strong> {{ selectedAppointmentHistory.status }}</p>
                                    <p v-if="selectedAppointmentHistory.notes"><strong>Notes:</strong> {{ selectedAppointmentHistory.notes }}</p>
                                </div>
                                
                                <!-- Treatment Details -->
                                <div v-if="selectedAppointmentHistory.treatment" class="mb-4">
                                    <h6>Treatment Details</h6>
                                    <p v-if="selectedAppointmentHistory.treatment.visit_type"><strong>Visit Type:</strong> {{ selectedAppointmentHistory.treatment.visit_type }}</p>
                                    <p v-if="selectedAppointmentHistory.treatment.diagnosis"><strong>Diagnosis:</strong> {{ selectedAppointmentHistory.treatment.diagnosis }}</p>
                                    <p v-if="selectedAppointmentHistory.treatment.prescription"><strong>Prescription:</strong> {{ selectedAppointmentHistory.treatment.prescription }}</p>
                                    <p v-if="selectedAppointmentHistory.treatment.treatment_notes"><strong>Treatment Notes:</strong> {{ selectedAppointmentHistory.treatment.treatment_notes }}</p>
                                </div>
                                
                                <div v-else class="mb-4">
                                    <h6>Treatment Details</h6>
                                    <p>No treatment details available.</p>
                                </div>
                                
                                <!-- Cancellation Details -->
                                <div v-if="selectedAppointmentHistory.status === 'cancelled' && selectedAppointmentHistory.cancellation_reason" class="mb-4">
                                    <h6>Cancellation Information</h6>
                                    <p><strong>Reason:</strong> {{ selectedAppointmentHistory.cancellation_reason }}</p>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Complete Treatment Modal -->
        <!-- Treatment Details Modal -->
        <div class="modal fade" id="treatmentDetailsModal" tabindex="-1" aria-labelledby="treatmentDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="treatmentDetailsModalLabel">Treatment Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" v-if="selectedTreatment">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Date:</strong> {{ selectedTreatment.created_at ? new Date(selectedTreatment.created_at).toLocaleDateString() : 'N/A' }}
                            </div>
                            <div class="col-md-6">
                                <strong>Doctor:</strong> {{ getTreatmentDoctor(selectedTreatment) }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <strong>Visit Type:</strong>
                            <p>{{ selectedTreatment.visit_type || 'N/A' }}</p>
                        </div>

                        <div class="mb-3" v-if="selectedTreatment.diagnosis">
                            <strong>Diagnosis:</strong>
                            <p>{{ selectedTreatment.diagnosis }}</p>
                        </div>
                        <div class="mb-3" v-if="selectedTreatment.prescription">
                            <strong>Prescription:</strong>
                            <p>{{ selectedTreatment.prescription }}</p>
                        </div>
                        <div class="mb-3" v-if="selectedTreatment.treatment_notes">
                            <strong>Treatment Notes:</strong>
                            <p>{{ selectedTreatment.treatment_notes }}</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="completeTreatmentModal" tabindex="-1" aria-labelledby="completeTreatmentModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="completeTreatmentModalLabel">Complete Appointment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="completeAppointmentWithTreatment()">
                            <div v-if="selectedAppointmentForTreatment" class="mb-3">
                                <p><strong>Patient:</strong> {{ selectedAppointmentForTreatment.patient ? selectedAppointmentForTreatment.patient.name : 'N/A' }}</p>
                                <p><strong>Date & Time:</strong> {{ selectedAppointmentForTreatment.appointment_date }} {{ selectedAppointmentForTreatment.appointment_time }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <label for="treatmentDiagnosis" class="form-label">Diagnosis <span class="text-danger">*</span></label>
                                <textarea 
                                    class="form-control" 
                                    id="treatmentDiagnosis" 
                                    v-model="completeTreatmentForm.diagnosis" 
                                    rows="3" 
                                    placeholder="Enter diagnosis (required)"
                                    required>
                                </textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="treatmentPrescription" class="form-label">Prescription</label>
                                <textarea 
                                    class="form-control" 
                                    id="treatmentPrescription" 
                                    v-model="completeTreatmentForm.prescription" 
                                    rows="3" 
                                    placeholder="Enter prescription details">
                                </textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="treatmentNotes" class="form-label">Treatment Notes <span class="text-danger">*</span></label>
                                <textarea 
                                    class="form-control" 
                                    id="treatmentNotes" 
                                    v-model="completeTreatmentForm.treatment_notes" 
                                    rows="3" 
                                    placeholder="Enter treatment notes (required)"
                                    required>
                                </textarea>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Both diagnosis and treatment notes are required to complete an appointment.
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" @click="completeAppointmentWithTreatment()" :disabled="loading">
                            <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                            <i class="bi bi-check"></i> Complete Appointment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Non-critical CSS - Can be at bottom */
        #app {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        
        #app.loaded {
            opacity: 1;
        }
        
        /* Loading overlay for smooth transitions */
        .app-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Application Scripts -->
    <script src="/static/js/services/api.js"></script>
    <script src="/static/js/modules/utils.js"></script>
    <script src="/static/js/modules/admin.js"></script>
    <script src="/static/js/modules/doctor.js"></script>
    <script src="/static/js/modules/patient.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>